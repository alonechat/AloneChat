<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>我的反馈</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; }
        h1 { color: #333; text-align: center; }
        .feedback-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .feedback-item:last-child { border-bottom: none; }
        .feedback-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .feedback-user { font-weight: bold; color: #0078ff; }
        .feedback-time { color: #888; font-size: 0.9em; }
        .feedback-content { margin-bottom: 10px; line-height: 1.6; }
        .feedback-status { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-pending { background-color: #ffedd5; color: #ea580c; }
        .status-processed { background-color: #dcfce7; color: #16a34a; }
        .feedback-reply { background-color: #f3f4f6; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .reply-label { font-weight: bold; color: #6b7280; margin-bottom: 5px; display: block; }
        .no-feedback { text-align: center; color: #888; padding: 30px 0; }
        .action-buttons { margin-top: 20px; text-align: center; }
        .action-buttons button { padding: 8px 15px; border: none; background-color: #0078ff; color: white; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .action-buttons button:hover { background-color: #0056b3; }
        .back-btn { background-color: #ddd !important; color: #333 !important; }
        .back-btn:hover { background-color: #ccc !important; }
    </style>
</head>
<body>
<div class="container">
    <h1>我的反馈</h1>
    <div id="feedbackList"></div>
    <div class="action-buttons">
        <button class="back-btn" onclick="window.location.href='/index.html'">返回聊天</button>
        <button id="giveFeedbackBtn" onclick="window.location.href='/index.html#feedback'">提交新反馈</button>
    </div>
</div>

<script>
    // 检查是否已登录
    document.addEventListener('DOMContentLoaded', function() {
        // 从localStorage获取authToken
        const authToken = localStorage.getItem('authToken');
        const username = localStorage.getItem('username');

        if (!authToken || !username) {
            // 未登录，重定向到登录页面
            window.location.href = '/login.html';
        } else {
            // 已登录，加载反馈列表
            loadFeedbackList();
        }
    });

    // 加载反馈列表
    function loadFeedbackList() {
        const feedbackListElement = document.getElementById('feedbackList');
        feedbackListElement.innerHTML = '<div class="loading">加载中...</div>';

        fetch('/api/feedback/my-feedback', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('获取反馈失败');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const feedbacks = data.feedbacks;

                if (feedbacks.length === 0) {
                    feedbackListElement.innerHTML = '<div class="no-feedback">您还没有提交任何反馈</div>';
                    return;
                }

                let html = '';
                feedbacks.forEach(feedback => {
                    const date = new Date(feedback.timestamp);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                    html += `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <span class="feedback-user">${feedback.user}</span>
                            <span class="feedback-time">${formattedDate}</span>
                        </div>
                        <div class="feedback-content">${feedback.content.replace(/\n/g, '<br>')}</div>
                        <span class="feedback-status status-${feedback.status}">${feedback.status === 'pending' ? '待处理' : '已处理'}</span>
                        ${feedback.reply ? `
                        <div class="feedback-reply">
                            <span class="reply-label">客服回复:</span>
                            ${feedback.reply.replace(/\n/g, '<br>')}
                        </div>` : ''}
                    </div>
                    `;
                });

                feedbackListElement.innerHTML = html;
            } else {
                feedbackListElement.innerHTML = `<div class="no-feedback">获取反馈失败: ${data.message || '未知错误'}</div>`;
            }
        })
        .catch(error => {
            console.error('加载反馈列表失败:', error);
            feedbackListElement.innerHTML = '<div class="no-feedback">加载反馈失败，请稍后重试</div>';
        });
    }
</script>
</body>
</html>