<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script>
        // 检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            // 从localStorage获取authToken
            const authToken = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');

            if (authToken && username) {
                // 已登录，重定向到聊天页面
                window.location.href = '/index.html';
            }

            // 从API获取默认服务器地址
            fetch('/api/get_default_server')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const defaultServer = data.default_server_address;
                        console.log('login.html: 从API获取默认服务器地址:', defaultServer);

                        // 优先从localStorage读取已保存的值
                        const savedServer = localStorage.getItem('serverAddress') || localStorage.getItem('defaultServer');
                        if (savedServer) {
                            console.log('login.html: 使用localStorage中保存的服务器地址:', savedServer);
                            document.getElementById('serverAddress').value = savedServer;
                        } else {
                            console.log('login.html: 使用API返回的默认服务器地址:', defaultServer);
                            document.getElementById('serverAddress').value = defaultServer;
                        }

                        // 更新placeholder为服务器默认地址
                        document.getElementById('serverAddress').placeholder = defaultServer;
                    } else {
                        console.error('login.html: 获取默认服务器地址失败');
                        // 使用硬编码默认值作为备选
                        document.getElementById('serverAddress').value = 'ws://localhost:8765';
                        document.getElementById('serverAddress').placeholder = 'ws://localhost:8765';
                    }
                })
                .catch(error => {
                    console.error('login.html: 获取默认服务器地址时发生错误:', error);
                    // 使用硬编码默认值作为备选
                    document.getElementById('serverAddress').value = 'ws://localhost:8765';
                    document.getElementById('serverAddress').placeholder = 'ws://localhost:8765';
                });
        });
    </script>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>AloneChat - 登录</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .server-config {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }

        .server-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .server-input input {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: #0078ff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: #0078ff;
            color: #0078ff;
            font-weight: 600;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .status {
            color: #666;
            font-size: 0.9em;
            margin-top: 15px;
            text-align: center;
        }

        .error-message {
            color: #ff0000;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="server-config">
        <h3>服务器配置</h3>
        <div class="server-input">
            <!--suppress HtmlFormInputWithoutLabel -->
            <input id="serverAddress" placeholder="ws://localhost:8765" type="text" value="ws://localhost:8765">
            <button onclick="saveServerAddress()">保存地址</button>
        </div>
        <div class="status" id="serverStatus"></div>
    </div>
    <h1>AloneChat</h1>

    <div class="tab-container">
        <div class="tab active" onclick="switchTab('login')">登录</div>
        <div class="tab" onclick="switchTab('register')">注册</div>
    </div>

    <div class="form-container active" id="loginForm">
        <div class="form-group">
            <label for="loginUsername">用户名</label>
            <input id="loginUsername" placeholder="输入用户名" type="text">
            <div class="error-message" id="loginUsernameError"></div>
        </div>
        <div class="form-group">
            <label for="loginPassword">密码</label>
            <input id="loginPassword" placeholder="输入密码" type="password">
            <div class="error-message" id="loginPasswordError"></div>
        </div>
        <button onclick="login()">登录</button>
        <div class="status" id="loginStatus"></div>
    </div>

    <div class="form-container" id="registerForm">
        <div class="form-group">
            <label for="registerUsername">用户名</label>
            <input id="registerUsername" placeholder="设置用户名" type="text">
            <div class="error-message" id="registerUsernameError"></div>
        </div>
        <div class="form-group">
            <label for="registerPassword">密码</label>
            <input id="registerPassword" placeholder="设置密码" type="password">
            <div class="error-message" id="registerPasswordError"></div>
        </div>
        <div class="form-group">
            <label for="registerConfirmPassword">确认密码</label>
            <input id="registerConfirmPassword" placeholder="再次输入密码" type="password">
            <div class="error-message" id="registerConfirmPasswordError"></div>
        </div>
        <button onclick="register()">注册</button>
        <div class="status" id="registerStatus"></div>
    </div>
</div>

<script src="/static/client.js"></script>
<script>
    // 保存服务器地址到本地存储
    // 转换URL协议的辅助函数
    function convertToWsUrl(url) {
        if (url.startsWith('ws://') || url.startsWith('wss://')) {
            return url;
        }
        if (url.startsWith('https://')) {
            return url.replace('https://', 'wss://');
        } else if (url.startsWith('http://')) {
            return url.replace('http://', 'ws://');
        }
        return 'ws://' + url;
    }

    function saveServerAddress() {
        const serverAddress = document.getElementById('serverAddress').value.trim();
        if (!serverAddress) {
            alert('请输入服务器地址');
            return;
        }
        // 转换地址协议
        const convertedUrl = convertToWsUrl(serverAddress);
        // 同时更新两个键，确保管理员页面和登录页面同步
        console.log('login.html: 保存serverAddress到localStorage:', convertedUrl);
        localStorage.setItem('serverAddress', convertedUrl);
        console.log('login.html: 保存defaultServer到localStorage:', convertedUrl);
        localStorage.setItem('defaultServer', convertedUrl);
        document.getElementById('serverStatus').textContent = '服务器地址已保存';
        document.getElementById('serverStatus').style.color = 'green';
        setTimeout(() => {
            document.getElementById('serverStatus').textContent = '';
        }, 2000);
    }

    // 覆盖client.js中的login函数
    const originalLogin = window.login;
    window.login = function() {
        // 先保存服务器地址
        const serverAddress = document.getElementById('serverAddress').value.trim();
        localStorage.setItem('serverAddress', serverAddress);

        // 调用原始登录函数
        originalLogin();
    };
</script>
<script>
    // 切换登录/注册选项卡
    function switchTab(tabName) {
        // 隐藏所有表单
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('registerForm').classList.remove('active');

        // 移除所有选项卡的活动状态
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // 显示选中的表单和选项卡
        document.getElementById(tabName + 'Form').classList.add('active');
        document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

        // 清除错误消息
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
        document.getElementById('loginStatus').textContent = '';
        document.getElementById('registerStatus').textContent = '';
    }

    // 注册功能
    function register() {
        // 获取表单数据
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
        let isValid = true;

        // 清除之前的错误消息
        document.querySelectorAll('#registerForm .error-message').forEach(el => el.textContent = '');
        document.getElementById('registerStatus').textContent = '';

        // 验证表单
        if (!username) {
            document.getElementById('registerUsernameError').textContent = '用户名不能为空';
            isValid = false;
        } else if (username.length < 3 || username.length > 20) {
            document.getElementById('registerUsernameError').textContent = '用户名长度应在3-20个字符之间';
            isValid = false;
        }

        if (!password) {
            document.getElementById('registerPasswordError').textContent = '密码不能为空';
            isValid = false;
        } else if (password.length < 6) {
            document.getElementById('registerPasswordError').textContent = '密码长度不能少于6个字符';
            isValid = false;
        }

        if (password !== confirmPassword) {
            document.getElementById('registerConfirmPasswordError').textContent = '两次输入的密码不一致';
            isValid = false;
        }

        if (!isValid) {
            return;
        }

        // 发送注册请求到后端API
        fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('registerStatus').textContent = '注册成功，请登录';
                document.getElementById('registerStatus').style.color = 'green';
                // 切换到登录选项卡
                setTimeout(() => switchTab('login'), 1500);
            } else {
                document.getElementById('registerStatus').textContent = data.message || '注册失败';
                document.getElementById('registerStatus').style.color = 'red';
            }
        })
        .catch(error => {
            console.error('注册请求失败:', error);
            document.getElementById('registerStatus').textContent = '注册请求失败，请检查网络连接';
            document.getElementById('registerStatus').style.color = 'red';
        });
    }
</script>
</body>
</html>